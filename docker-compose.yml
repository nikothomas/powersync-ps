services:
  mongo:
    image: mongo:7.0
    command: --replSet rs0 --bind_ip_all --quiet
    restart: unless-stopped
    ports:
      - 27017:27017
    volumes:
      - mongo_storage:/data/db

  # Initializes the MongoDB replica set. This service will not usually be actively running
  mongo-rs-init:
    image: mongo:7.0
    depends_on:
      - mongo
    restart: on-failure
    entrypoint:
      - bash
      - -c
      - 'mongosh --host mongo:27017 --eval ''try{rs.status().ok && quit(0)} catch {} rs.initiate({_id: "rs0", version: 1, members: [{ _id: 0, host : "mongo:27017" }]})'''

  # PowerSync service
  powersync:
    image: journeyapps/powersync-service:latest
    container_name: powersync
    depends_on:
      - mongo-rs-init
    command: [ "start", "-r", "unified" ]
    restart: unless-stopped
    environment:
      - NODE_OPTIONS=--max-old-space-size=1000
      - POWERSYNC_CONFIG_B64=dGVsZW1ldHJ5Og0KZGlzYWJsZV90ZWxlbWV0cnlfc2hhcmluZzogdHJ1ZQ0KcmVwbGljYXRpb246DQogIGNvbm5lY3Rpb25zOg0KICAgIC0gdHlwZTogcG9zdGdyZXNxbA0KICAgICAgaG9zdG5hbWU6IGRiLnB2aWt3a25ueGN1dWhpd3VuZ3FoLnN1cGFiYXNlLmNvDQogICAgICBwb3J0OiA1NDMyDQogICAgICBkYXRhYmFzZTogcG9zdGdyZXMNCiAgICAgIHVzZXJuYW1lOiBwb3N0Z3Jlcw0KICAgICAgcGFzc3dvcmQ6IDE3MjhQb2xlc2hpZnQkdHVkZW50DQogICAgICBzc2xtb2RlOiB2ZXJpZnktZnVsbA0Kc3RvcmFnZToNCiAgdHlwZTogbW9uZ29kYg0KICB1cmk6IG1vbmdvZGI6Ly9tb25nbzoyNzAxNy9wb3dlcnN5bmMtcHMNCnBvcnQ6IDgwNzANCnN5bmNfcnVsZXM6DQogIHBhdGg6IC9ob21lL2NvbmZpZy9zeW5jX3J1bGVzLnlhbWwNCmNsaWVudF9hdXRoOg0KICBzdXBhYmFzZTogdHJ1ZQ0KICBzdXBhYmFzZV9qd3Rfc2VjcmV0OiA0UGl3QW45SS9iNlNqS1lCaHVZUEpIejBOR0RDcm1pZWZOKzhoczgyUHFPRkFaNWNKZUVGalhIUnd4QVBIWEhuMUp6S1R0U292UGhsMVA3TlVZVSs2Zz09DQogIGF1ZGllbmNlOiBbInBvd2Vyc3luYy1kZXYiLCAicG93ZXJzeW5jIl0NCmFwaToNCiAgdG9rZW5zOg0KICAgIC0gZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKemRYQmhZbUZ6WlNJc0luSmxaaUk2SW5CMmFXdDNhMjV1ZUdOMWRXaHBkM1Z1WjNGb0lpd2ljbTlzWlNJNkltRnViMjRpTENKcFlYUWlPakUzTWpnME5UUTBNRE1zSW1WNGNDSTZNakEwTkRBek1EUXdNMzAuX3FWUUFsWW9MNWp0U1ZDQUtJem5RXzVwSTczS2UwOFl6Wm5veV81ME5wZw==
      - PS_SUPABASE_AUTH=true
    ports:
      - "8070:8070"
    volumes:
      - ./config/sync_rules.yaml:/home/config/sync_rules.yaml
    networks:
      - default
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:${PS_PORT}/probes/liveness').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"
        ]
      interval: 5s
      timeout: 1s
      retries: 15
volumes:
  mongo_storage:
